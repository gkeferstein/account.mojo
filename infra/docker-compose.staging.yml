# Docker Compose - Staging Environment
# Domain: account.staging.mojo-institut.de
# Basic Auth: Aktiviert (staging-basicauth Middleware)

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: accounts-db-staging
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-accounts}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-accounts_secret}
      POSTGRES_DB: ${POSTGRES_DB:-accounts_db}
    volumes:
      - accounts-db-staging-data:/var/lib/postgresql/data
    networks:
      - mojo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-accounts}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Fastify API Backend
  api:
    container_name: accounts-api-staging
    image: ${API_IMAGE:-ghcr.io/gkeferstein/account.mojo-api:main-latest}
    depends_on:
      db:
        condition: service_healthy
    environment:
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-accounts}:${POSTGRES_PASSWORD:-accounts_secret}@db:5432/${POSTGRES_DB:-accounts_db}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY}
      PAYMENTS_API_URL: ${PAYMENTS_API_URL:-https://payments.mojo-institut.de/api}
      PAYMENTS_API_KEY: ${PAYMENTS_API_KEY}
      CRM_API_URL: ${CRM_API_URL:-https://kontakte.mojo-institut.de/api}
      CRM_API_KEY: ${CRM_API_KEY}
      CRM_TENANT_SLUG: ${CRM_TENANT_SLUG:-mojo}
      MOCK_EXTERNAL_SERVICES: ${MOCK_EXTERNAL_SERVICES:-false}
      WEBHOOK_SECRET_PAYMENTS: ${WEBHOOK_SECRET_PAYMENTS}
      WEBHOOK_SECRET_CRM: ${WEBHOOK_SECRET_CRM}
      FRONTEND_URL: ${FRONTEND_URL:-https://account.staging.mojo-institut.de}
    networks:
      - mojo-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=mojo-network"
      # Clerk Webhook Routes (OHNE Basic Auth) - Priority 20 (höchste Priorität)
      # Diese Routen müssen von Basic Auth ausgenommen werden für Webhook-Verarbeitung
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/api/v1/webhooks/clerk`)"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.tls=true"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-clerk-webhook-v1-staging.priority=20"
      - "traefik.http.routers.accounts-clerk-webhook-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/api/webhooks/clerk`)"
      - "traefik.http.routers.accounts-clerk-webhook-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-clerk-webhook-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-clerk-webhook-staging.tls=true"
      - "traefik.http.routers.accounts-clerk-webhook-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-clerk-webhook-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-clerk-webhook-staging.priority=20"
      # Health Check Routes (OHNE Basic Auth) - Priority 15
      - "traefik.http.routers.accounts-health-root-staging.rule=Host(`account.staging.mojo-institut.de`) && Path(`/health`)"
      - "traefik.http.routers.accounts-health-root-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-health-root-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-health-root-staging.tls=true"
      - "traefik.http.routers.accounts-health-root-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-health-root-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-health-root-staging.priority=15"
      - "traefik.http.routers.accounts-health-api-staging.rule=Host(`account.staging.mojo-institut.de`) && Path(`/api/health`)"
      - "traefik.http.routers.accounts-health-api-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-health-api-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-health-api-staging.tls=true"
      - "traefik.http.routers.accounts-health-api-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-health-api-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-health-api-staging.priority=15"
      - "traefik.http.routers.accounts-health-v1-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/api/v1/health`)"
      - "traefik.http.routers.accounts-health-v1-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-health-v1-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-health-v1-staging.tls=true"
      - "traefik.http.routers.accounts-health-v1-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-health-v1-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-health-v1-staging.priority=15"
      # Main API Routes (MIT Basic Auth) - Priority 1 (niedrigste Priorität)
      - "traefik.http.routers.accounts-api-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/api`) && !PathPrefix(`/api/v1/webhooks/clerk`) && !PathPrefix(`/api/webhooks/clerk`) && !Path(`/health`) && !Path(`/api/health`) && !PathPrefix(`/api/v1/health`)"
      - "traefik.http.routers.accounts-api-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-api-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-api-staging.tls=true"
      - "traefik.http.routers.accounts-api-staging.middlewares=staging-basicauth@file,staging-headers@file"
      - "traefik.http.routers.accounts-api-staging.service=accounts-api-staging"
      - "traefik.http.routers.accounts-api-staging.priority=1"
      # Service
      - "traefik.http.services.accounts-api-staging.loadbalancer.server.port=3001"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Next.js Web Frontend
  web:
    container_name: accounts-web-staging
    image: ${WEB_IMAGE:-ghcr.io/gkeferstein/account.mojo-web:main-latest}
    environment:
      PORT: 3020
      NODE_ENV: staging
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
    expose:
      - "3020"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - mojo-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=mojo-network"
      # Clerk Auth Routes (OHNE Basic Auth) - Priority 20 (höchste Priorität)
      # Diese Routen müssen von Basic Auth ausgenommen werden, um Auth-Loops zu vermeiden
      - "traefik.http.routers.accounts-clerk-signin-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/sign-in`)"
      - "traefik.http.routers.accounts-clerk-signin-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-clerk-signin-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-clerk-signin-staging.tls=true"
      - "traefik.http.routers.accounts-clerk-signin-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-clerk-signin-staging.service=accounts-web-staging"
      - "traefik.http.routers.accounts-clerk-signin-staging.priority=20"
      - "traefik.http.routers.accounts-clerk-signup-staging.rule=Host(`account.staging.mojo-institut.de`) && PathPrefix(`/sign-up`)"
      - "traefik.http.routers.accounts-clerk-signup-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-clerk-signup-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-clerk-signup-staging.tls=true"
      - "traefik.http.routers.accounts-clerk-signup-staging.middlewares=staging-headers@file"
      - "traefik.http.routers.accounts-clerk-signup-staging.service=accounts-web-staging"
      - "traefik.http.routers.accounts-clerk-signup-staging.priority=20"
      # Main Frontend Routes (MIT Basic Auth) - Priority 1 (niedrigste Priorität)
      - "traefik.http.routers.accounts-web-staging.rule=Host(`account.staging.mojo-institut.de`) && !PathPrefix(`/api`) && !PathPrefix(`/sign-in`) && !PathPrefix(`/sign-up`) && !PathPrefix(`/api/webhook`) && !PathPrefix(`/api/clerk`)"
      - "traefik.http.routers.accounts-web-staging.entrypoints=websecure"
      - "traefik.http.routers.accounts-web-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.accounts-web-staging.tls=true"
      - "traefik.http.routers.accounts-web-staging.middlewares=staging-basicauth@file,staging-headers@file"
      - "traefik.http.routers.accounts-web-staging.service=accounts-web-staging"
      - "traefik.http.routers.accounts-web-staging.priority=1"
      # Service
      - "traefik.http.services.accounts-web-staging.loadbalancer.server.port=3020"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "-O", "/dev/null", "http://localhost:3020/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

networks:
  mojo-network:
    name: mojo-network
    external: true

volumes:
  accounts-db-staging-data:
    name: accounts-db-staging-data
    driver: local

