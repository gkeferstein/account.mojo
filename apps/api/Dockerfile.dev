FROM node:22-slim

# Install OpenSSL for Prisma
RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy shared package first
COPY packages/shared /app/packages/shared
WORKDIR /app/packages/shared
RUN npm install && npm run build

# Now setup API
WORKDIR /app/api

# Copy package files
COPY apps/api/package*.json ./

# Remove @accounts/shared from package.json since we'll link it
RUN npm pkg delete dependencies.@accounts/shared || true

# Install dependencies
RUN npm install

# Link shared package
RUN npm link /app/packages/shared

# Copy prisma schema
COPY apps/api/prisma ./prisma/

# Generate Prisma Client
RUN npx prisma generate

# Copy source
COPY apps/api/src ./src/
COPY apps/api/tsconfig.json ./

EXPOSE 3001

CMD ["npm", "run", "dev"]
