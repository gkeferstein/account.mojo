FROM node:22-slim
WORKDIR /app

# Copy shared package first
COPY packages/shared /app/packages/shared
WORKDIR /app/packages/shared
RUN npm install && npm run build

# Now setup web
WORKDIR /app/web

# Copy package files
COPY apps/web/package*.json ./

# Remove @accounts/shared from package.json since we'll link it
RUN npm pkg delete dependencies.@accounts/shared || true

# Install dependencies
RUN npm install

# Link shared package
RUN npm link /app/packages/shared

# Copy source
COPY apps/web/src ./src/
COPY apps/web/public ./public/
COPY apps/web/tsconfig.json ./
COPY apps/web/tailwind.config.ts ./
COPY apps/web/postcss.config.mjs ./
COPY apps/web/next.config.ts ./

EXPOSE 3000

CMD ["npm", "run", "dev"]
